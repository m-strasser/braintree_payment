<?php

/**
 * @file
 * Tests for the available testing nonces from Braintree.
 *
 * See: https://developers.braintreepayments.com/reference/general/testing/php
 */

use Drupal\braintree_payment\CreditCardController;

/**
 * Mocks some drupal specific functions.
 */
final class PHPUnitCreditCardController extends CreditCardController {
  /**
   * @var
   * PUT YOUR SANDBOX API KEYS HERE
   */
  const DEFAULT_CONTROLLER_DATA = array(
    'environment' => 'sandbox',
    'merchant_id' => '',
    'public_key' => '',
    'private_key' => '',
  );

  /**
   * Monkeypatch constructor because it uses t().
   */
  public function __construct() {
    $this->title = 'Braintree Credit Card';

    $this->payment_configuration_form_elements_callback = 'payment_forms_payment_form';
    $this->payment_method_configuration_form_elements_callback = 'payment_forms_method_configuration_form';
  }

  /**
   * Mock drupal_set_message.
   */
  public function drupal_set_message($msg) {
    print $msg;
    return TRUE;
  }

  /**
   * Mock drupal_write_record.
   */
  public function drupal_write_record($table, $params) {
    print $table . ': ' . implode('|', $params);
    return TRUE;
  }

  /**
   * Mock entity_save.
   */
  public function entity_save($entity_name, $entity_data) {
    print $entity_name . ': ' .  json_encode($entity_data);
    return TRUE;
  }

  /**
   * Mock libraries_load.
   */
  public function libraries_load($library) {
    return TRUE;
  }

}
/**
 * The actual TestCase.
 */
class NoncesTestCase extends DrupalWebTestCase {

  /**
   * Set up info for the test case.
   */
  public static function getInfo() {
    return array(
      'name' => 'Nonces Test',
      'description' => 'Tests the backend part with Braintree testing nonces.',
      'group' => 'Braintree_Payment',
    );
  }

  /**
   * Loads necessary modules and creates controller instance.
   */
  public function setUp() {
    parent::setUp(
      array(
        'libraries',
        'payment',
        'payment_context',
        'payment_controller_data',
        'payment_forms',
        'webform_paymethod_select',
        'xautoload',
        'braintree_payment',
      )
    );
    $this->ccc = new PHPUnitCreditCardController();
  }

  /**
   * Test if braintree_payment accepts fake-valid-nonce.
   */
  public function testFakeValidNonce() {
    $amount = rand(1, 1999);
    $payment_params = array(
      'uid' => 1,
      'contextObj' => $this->setUpPaymentContext('Testee', 'Test', 't@t.at'),
      'method' => $this->setUpMethod(),
      'method_data' => $this->setUpMethodData('fake-valid-nonce'),
      'line_items' => $this->mockLineItems($amount),
    );
    $payment = new Payment($payment_params);

    $this->ccc->execute($payment);
    $this->assertEqual($payment->statuses[1]->status, 'payment_status_success');
  }

  /**
   * Test if braintree_payment accepts fake-valid-nonce with the corresponding amounts.
   */
  public function testFakeValidNonceTestAmounts() {
    // Authorization Response: Authorized
    // Settlement Response: Settled.
    $amount = rand(1, 1999);
    $payment_params = array(
      'uid' => 1,
      'contextObj' => $this->setUpPaymentContext('Testee', 'Test', 't@t.at'),
      'method' => $this->setUpMethod(),
      'method_data' => $this->setUpMethodData('fake-valid-nonce'),
      'line_items' => $this->mockLineItems($amount),
    );
    $payment = new Payment($payment_params);

    $this->ccc->execute($payment);
    $this->assertEqual($payment->statuses[1]->status, 'payment_status_success');

    // Authorization Response: Processor Declined
    // Settlement Response: n/a.
    $amount = rand(2000, 3000);
    $payment_params = array(
      'uid' => 1,
      'contextObj' => $this->setUpPaymentContext('Testee', 'Test', 't@t.at'),
      'method' => $this->setUpMethod(),
      'method_data' => $this->setUpMethodData('fake-valid-nonce'),
      'line_items' => $this->mockLineItems($amount),
    );
    $payment = new Payment($payment_params);

    $this->ccc->execute($payment);
    $this->assertEqual($payment->statuses[1]->status, 'payment_status_failed');

    // Authorization Response: Authorized
    // Settlement Response: Settled.
    $amount = rand(3001, 4000);
    $payment_params = array(
      'uid' => 1,
      'contextObj' => $this->setUpPaymentContext('Testee', 'Test', 't@t.at'),
      'method' => $this->setUpMethod(),
      'method_data' => $this->setUpMethodData('fake-valid-nonce'),
      'line_items' => $this->mockLineItems($amount),
    );
    $payment = new Payment($payment_params);

    $this->ccc->execute($payment);
    $this->assertEqual($payment->statuses[1]->status, 'payment_status_success');

    // Authorization Response: Authorized
    // Settlement Response: Settlement Declined or Settled
    // see: https://developers.braintreepayments.com/reference/general/statuses#settlement-declined
    $amount = 4001;
    $payment_params = array(
      'uid' => 1,
      'contextObj' => $this->setUpPaymentContext('Testee', 'Test', 't@t.at'),
      'method' => $this->setUpMethod(),
      'method_data' => $this->setUpMethodData('fake-valid-nonce'),
      'line_items' => $this->mockLineItems($amount),
    );
    $payment = new Payment($payment_params);

    $this->ccc->execute($payment);
    $this->assertEqual($payment->statuses[1]->status, 'payment_status_success');

    // Authorization Response: Authorized
    // Settlement Response: Settlement Declined or Settled.
    $amount = 4001;
    $payment_params = array(
      'uid' => 1,
      'contextObj' => $this->setUpPaymentContext('Testee', 'Test', 't@t.at'),
      'method' => $this->setUpMethod(),
      'method_data' => $this->setUpMethodData('fake-valid-nonce'),
      'line_items' => $this->mockLineItems($amount),
    );
    $payment = new Payment($payment_params);

    // @TODO: Does this fail for the right reasons?
    $this->ccc->execute($payment);
    $this->assertEqual($payment->statuses[1]->status, 'payment_status_success');

    // Authorization Response: Gateway rejected
    // Settlement Response: n/a.
    $amount = 5001;
    $payment_params = array(
      'uid' => 1,
      'contextObj' => $this->setUpPaymentContext('Testee', 'Test', 't@t.at'),
      'method' => $this->setUpMethod(),
      'method_data' => $this->setUpMethodData('fake-valid-nonce'),
      'line_items' => $this->mockLineItems($amount),
    );
    $payment = new Payment($payment_params);

    $this->ccc->execute($payment);
    $this->assertEqual($payment->statuses[1]->status, 'payment_status_failed');

    // Authorization Response: Processor Declined
    // Settlement Response: n/a.
    // @TODO: THIS SHOULD FAIL!
    $amount = 5001.01;
    $payment_params = array(
      'uid' => 1,
      'contextObj' => $this->setUpPaymentContext('Testee', 'Test', 't@t.at'),
      'method' => $this->setUpMethod(),
      'method_data' => $this->setUpMethodData('fake-valid-nonce'),
      'line_items' => $this->mockLineItems($amount),
    );
    $payment = new Payment($payment_params);

    $this->ccc->execute($payment);
    $this->assertEqual($payment->statuses[1]->status, 'payment_status_failed');

    // Authorization Response: Authorized
    // Settlement Response: Processor Unavailable.
    $amount = 5001.02;
    $payment_params = array(
      'uid' => 1,
      'contextObj' => $this->setUpPaymentContext('Testee', 'Test', 't@t.at'),
      'method' => $this->setUpMethod(),
      'method_data' => $this->setUpMethodData('fake-valid-nonce'),
      'line_items' => $this->mockLineItems($amount),
    );
    $payment = new Payment($payment_params);

    $this->ccc->execute($payment);
    $this->assertEqual($payment->statuses[1]->status, 'payment_status_success');
  }

  /**
   * Test if braintree_payment accepts fake-valid-no-billing-address-nonce.
   */
  public function testFakeValidNoBillingAddressNonce() {
    $amount = rand(1, 1999);
    $payment_params = array(
      'uid' => 1,
      'contextObj' => $this->setUpPaymentContext('Testee', 'Test', 't@t.at'),
      'method' => $this->setUpMethod(),
      'method_data' => $this->setUpMethodData('fake-valid-no-billing-address-nonce'),
      'line_items' => $this->mockLineItems($amount),
    );
    $payment = new Payment($payment_params);

    $this->ccc->execute($payment);
    $this->assertEqual($payment->statuses[1]->status, 'payment_status_success');
  }

  /**
   * Test if braintree_payment accepts fake-valid-visa-nonce.
   */
  public function testFakeValidVisaNonce() {
    $amount = rand(1, 1999);
    $payment_params = array(
      'uid' => 1,
      'contextObj' => $this->setUpPaymentContext('Testee', 'Test', 't@t.at'),
      'method' => $this->setUpMethod(),
      'method_data' => $this->setUpMethodData('fake-valid-visa-nonce'),
      'line_items' => $this->mockLineItems($amount),
    );
    $payment = new Payment($payment_params);

    $this->ccc->execute($payment);
    $this->assertEqual($payment->statuses[1]->status, 'payment_status_success');
  }

  /**
   * Test if braintree_payment accepts fake-valid-amex-nonce.
   */
  public function testFakeValidAmexNonce() {
    $amount = rand(1, 1999);
    $payment_params = array(
      'uid' => 1,
      'contextObj' => $this->setUpPaymentContext('Testee', 'Test', 't@t.at'),
      'method' => $this->setUpMethod(),
      'method_data' => $this->setUpMethodData('fake-valid-amex-nonce'),
      'line_items' => $this->mockLineItems($amount),
    );
    $payment = new Payment($payment_params);

    $this->ccc->execute($payment);
    $this->assertEqual($payment->statuses[1]->status, 'payment_status_success');
  }

  /**
   * Test if braintree_payment accepts fake-valid-mastercard-nonce.
   */
  public function testFakeValidMasterCardNonce() {
    $amount = rand(1, 1999);
    $payment_params = array(
      'uid' => 1,
      'contextObj' => $this->setUpPaymentContext('Testee', 'Test', 't@t.at'),
      'method' => $this->setUpMethod(),
      'method_data' => $this->setUpMethodData('fake-valid-mastercard-nonce'),
      'line_items' => $this->mockLineItems($amount),
    );
    $payment = new Payment($payment_params);

    $this->ccc->execute($payment);
    $this->assertEqual($payment->statuses[1]->status, 'payment_status_success');
  }

  /**
   * Test if braintree_payment accepts fake-valid-discover-nonce.
   */
  public function testFakeValidDiscoverNonce() {
    $amount = rand(1, 1999);
    $payment_params = array(
      'uid' => 1,
      'contextObj' => $this->setUpPaymentContext('Testee', 'Test', 't@t.at'),
      'method' => $this->setUpMethod(),
      'method_data' => $this->setUpMethodData('fake-valid-discover-nonce'),
      'line_items' => $this->mockLineItems($amount),
    );
    $payment = new Payment($payment_params);

    $this->ccc->execute($payment);
    $this->assertEqual($payment->statuses[1]->status, 'payment_status_success');
  }

  /**
   * Test if braintree_payment accepts fake-valid-jcb-nonce.
   */
  public function testFakeValidJCBNonce() {
    $amount = rand(1, 1999);
    $payment_params = array(
      'uid' => 1,
      'contextObj' => $this->setUpPaymentContext('Testee', 'Test', 't@t.at'),
      'method' => $this->setUpMethod(),
      'method_data' => $this->setUpMethodData('fake-valid-jcb-nonce'),
      'line_items' => $this->mockLineItems($amount),
    );
    $payment = new Payment($payment_params);

    $this->ccc->execute($payment);
    $this->assertEqual($payment->statuses[1]->status, 'payment_status_success');
  }

  /**
   * Test if braintree_payment accepts fake-valid-maestro-nonce.
   */
  public function testFakeValidMaestroNonce() {
    $amount = rand(1, 1999);
    $payment_params = array(
      'uid' => 1,
      'contextObj' => $this->setUpPaymentContext('Testee', 'Test', 't@t.at'),
      'method' => $this->setUpMethod(),
      'method_data' => $this->setUpMethodData('fake-valid-maestro-nonce'),
      'line_items' => $this->mockLineItems($amount),
    );
    $payment = new Payment($payment_params);

    $this->ccc->execute($payment);
    $this->assertEqual($payment->statuses[1]->status, 'payment_status_success');
  }

  /**
   * Test if braintree_payment accepts fake-valid-prepaid-nonce.
   */
  public function testFakeValidPrepaidNonce() {
    $amount = rand(1, 1999);
    $payment_params = array(
      'uid' => 1,
      'contextObj' => $this->setUpPaymentContext('Testee', 'Test', 't@t.at'),
      'method' => $this->setUpMethod(),
      'method_data' => $this->setUpMethodData('fake-valid-prepaid-nonce'),
      'line_items' => $this->mockLineItems($amount),
    );
    $payment = new Payment($payment_params);

    $this->ccc->execute($payment);
    $this->assertEqual($payment->statuses[1]->status, 'payment_status_success');
  }

  /**
   * Test if braintree_payment accepts fake-valid-commercial-nonce.
   */
  public function testFakeValidCommericalNonce() {
    $amount = rand(1, 1999);
    $payment_params = array(
      'uid' => 1,
      'contextObj' => $this->setUpPaymentContext('Testee', 'Test', 't@t.at'),
      'method' => $this->setUpMethod(),
      'method_data' => $this->setUpMethodData('fake-valid-commercial-nonce'),
      'line_items' => $this->mockLineItems($amount),
    );
    $payment = new Payment($payment_params);

    $this->ccc->execute($payment);
    $this->assertEqual($payment->statuses[1]->status, 'payment_status_success');
  }

  /**
   * Test if braintree_payment accepts fake-valid-drubin-regulated-nonce.
   */
  public function testFakeValidDurbinRegulatedNonce() {
    $amount = rand(1, 1999);
    $payment_params = array(
      'uid' => 1,
      'contextObj' => $this->setUpPaymentContext('Testee', 'Test', 't@t.at'),
      'method' => $this->setUpMethod(),
      'method_data' => $this->setUpMethodData('fake-valid-durbin-regulated-nonce'),
      'line_items' => $this->mockLineItems($amount),
    );
    $payment = new Payment($payment_params);

    $this->ccc->execute($payment);
    $this->assertEqual($payment->statuses[1]->status, 'payment_status_success');
  }

  /**
   * Test if braintree_payment accepts fake-valid-healthcare-nonce.
   */
  public function testFakeValidHealthcareNonce() {
    $amount = rand(1, 1999);
    $payment_params = array(
      'uid' => 1,
      'contextObj' => $this->setUpPaymentContext('Testee', 'Test', 't@t.at'),
      'method' => $this->setUpMethod(),
      'method_data' => $this->setUpMethodData('fake-valid-healthcare-nonce'),
      'line_items' => $this->mockLineItems($amount),
    );
    $payment = new Payment($payment_params);

    $this->ccc->execute($payment);
    $this->assertEqual($payment->statuses[1]->status, 'payment_status_success');
  }

  /**
   * Test if braintree_payment accepts fake-valid-debit-nonce.
   */
  public function testFakeValidDebitNonce() {
    $amount = rand(1, 1999);
    $payment_params = array(
      'uid' => 1,
      'contextObj' => $this->setUpPaymentContext('Testee', 'Test', 't@t.at'),
      'method' => $this->setUpMethod(),
      'method_data' => $this->setUpMethodData('fake-valid-debit-nonce'),
      'line_items' => $this->mockLineItems($amount),
    );
    $payment = new Payment($payment_params);

    $this->ccc->execute($payment);
    $this->assertEqual($payment->statuses[1]->status, 'payment_status_success');
  }

  /**
   * Test if braintree_payment accepts fake-valid-payroll-nonce.
   */
  public function testFakeValidPayrollNonce() {
    $amount = rand(1, 1999);
    $payment_params = array(
      'uid' => 1,
      'contextObj' => $this->setUpPaymentContext('Testee', 'Test', 't@t.at'),
      'method' => $this->setUpMethod(),
      'method_data' => $this->setUpMethodData('fake-valid-payroll-nonce'),
      'line_items' => $this->mockLineItems($amount),
    );
    $payment = new Payment($payment_params);

    $this->ccc->execute($payment);
    $this->assertEqual($payment->statuses[1]->status, 'payment_status_success');
  }

  /**
   * Test if braintree_payment accepts fake-valid-no-indicators-nonce.
   */
  public function testFakeValidNoIndicatorsNonce() {
    $amount = rand(1, 1999);
    $payment_params = array(
      'uid' => 1,
      'contextObj' => $this->setUpPaymentContext('Testee', 'Test', 't@t.at'),
      'method' => $this->setUpMethod(),
      'method_data' => $this->setUpMethodData('fake-valid-no-indicators-nonce'),
      'line_items' => $this->mockLineItems($amount),
    );
    $payment = new Payment($payment_params);

    $this->ccc->execute($payment);
    $this->assertEqual($payment->statuses[1]->status, 'payment_status_success');
  }

  /**
   * Test if braintree_payment accepts fake-valid-unknown-indicators-nonce.
   */
  public function testFakeValidUnknownIndicatorsNonce() {
    $amount = rand(1, 1999);
    $payment_params = array(
      'uid' => 1,
      'contextObj' => $this->setUpPaymentContext('Testee', 'Test', 't@t.at'),
      'method' => $this->setUpMethod(),
      'method_data' => $this->setUpMethodData('fake-valid-unknown-indicators-nonce'),
      'line_items' => $this->mockLineItems($amount),
    );
    $payment = new Payment($payment_params);

    $this->ccc->execute($payment);
    $this->assertEqual($payment->statuses[1]->status, 'payment_status_success');
  }

  /**
   * Test if braintree_payment accepts fake-valid-country-of-issuance-usa-nonce.
   */
  public function testFakeValidCountryOfIssuanceUSANonce() {
    $amount = rand(1, 1999);
    $payment_params = array(
      'uid' => 1,
      'contextObj' => $this->setUpPaymentContext('Testee', 'Test', 't@t.at'),
      'method' => $this->setUpMethod(),
      'method_data' => $this->setUpMethodData('fake-valid-country-of-issuance-usa-nonce'),
      'line_items' => $this->mockLineItems($amount),
    );
    $payment = new Payment($payment_params);

    $this->ccc->execute($payment);
    $this->assertEqual($payment->statuses[1]->status, 'payment_status_success');
  }

  /**
   * Test if braintree_payment accepts fake-valid-country-of-issuance-cad-nonce.
   */
  public function testFakeValidCountryOfIssuanceCanadaNonce() {
    $amount = rand(1, 1999);
    $payment_params = array(
      'uid' => 1,
      'contextObj' => $this->setUpPaymentContext('Testee', 'Test', 't@t.at'),
      'method' => $this->setUpMethod(),
      'method_data' => $this->setUpMethodData('fake-valid-country-of-issuance-cad-nonce'),
      'line_items' => $this->mockLineItems($amount),
    );
    $payment = new Payment($payment_params);

    $this->ccc->execute($payment);
    $this->assertEqual($payment->statuses[1]->status, 'payment_status_success');
  }

  /**
   * Test if braintree_payment accepts fake-valid-issuing-bank-network-only-nonce.
   */
  public function testFakeValidBankNetworkOnlyNonce() {
    $amount = rand(1, 1999);
    $payment_params = array(
      'uid' => 1,
      'contextObj' => $this->setUpPaymentContext('Testee', 'Test', 't@t.at'),
      'method' => $this->setUpMethod(),
      'method_data' => $this->setUpMethodData('fake-valid-issuing-bank-network-only-nonce'),
      'line_items' => $this->mockLineItems($amount),
    );
    $payment = new Payment($payment_params);

    $this->ccc->execute($payment);
    $this->assertEqual($payment->statuses[1]->status, 'payment_status_success');
  }

  /**
   * Mock payment context.
   */
  private function setUpPaymentContext($first, $last, $email) {
    return new MockedContext(
      array(
        'first_name' => $first,
        'last_name' => $last,
        'email' => $email,
      )
    );
  }

  /**
   * Mock setup method.
   */
  private function setUpMethod($controller_data = PHPUnitCreditCardController::DEFAULT_CONTROLLER_DATA) {
    return new MockedMethod(1234, 'test_payment_method', $controller_data);
  }

  /**
   * Mock setup method data.
   */
  private function setUpMethodData($nonce) {
    return array('braintree-payment-nonce' => $nonce);
  }

  /**
   * Mock lineitems.
   */
  private function mockLineItems($amount) {
    return array(new PaymentLineItem(array(
      'amount' => $amount,
      'donation' => array(
        'amount_source' => 'component',
        'amount_component' => '9',
        'quantity_source' => 'fixed',
        'quantity_component' => NULL,
        'amount' => $amount,
        'description' => 'Donation',
        'description_arguments' => [],
        'name' => 'donation',
        'tax_rate' => 0,
        'quantity' => 1,
      ),
    )),
    );
  }

}

/**
 * Represents a mocked $method for the $payment variable passed to the
 * execute($payment) function.
 */
class MockedMethod {
  public $controller_data;

  /**
   * Creates a new mocked method.
   */
  public function __construct($pmid, $title_specific, $controllerData) {
    $this->controller_data = $controllerData;
    $this->pmid = $pmid;
    $this->title_specific = $title_specific;
  }

}

/**
 * Represents a mocked $contextObj for the $payment variable passed to the
 * execute($payment) function.
 */
class MockedContext {

  /**
   * Creates a new mocked context.
   * @param array $fields Associative array mocking input field IDs.
   */
  public function __construct($fields) {
    $this->fields = $fields;
  }

  /**
   * Gets the value of a mocked input field.
   * @param int $field The ID of a mocked input field.
   * @return
   * The value of the mocked input field.
   */
  public function value($field) {
    return $this->fields[$field];
  }

}
